name: Build and Publish RCPT Addon

on:
  push:
    tags:
      - 'v*'   # catches both vX.Y.Z and vX.Y.Z-beta

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      RETAIL_INTERFACE: 110207
      BETA_INTERFACE:   120001

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Decide release mode
        id: decide
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          BASE="${TAG%-beta}"          # strip -beta suffix if present
          IS_BETA="false"
          if [[ "$TAG" == *"-beta"* ]]; then
            IS_BETA="true"
          fi
          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "is_beta=$IS_BETA" >> "$GITHUB_OUTPUT"

      - name: Prepare addon folder
        run: |
          set -e
          rm -rf release
          mkdir -p release
          cp -r RCPT RCPT_PullTimers RCPT_TalentCheck release/

      - name: If retail build needed, create retail release
        if: steps.decide.outputs.is_beta == 'false'
        run: |
          set -e
          BASE="${{ steps.decide.outputs.base }}"
          echo "Generating Retail release for $BASE"

          # Ensure retail TOC is unchanged
          # (the files already have Retail interface assumed correct)

          cd release
          zip -r "RCPT_${BASE}_Retail.zip" RCPT RCPT_PullTimers RCPT_TalentCheck

          # Create release.json for retail
          cat > "release.json" <<EOF
          {
            "releases": [
              {
                "name": "RCPT",
                "version": "${BASE}",
                "filename": "RCPT_${BASE}_Retail.zip",
                "nolib": false,
                "metadata": [
                  {
                    "flavor": "mainline",
                    "interface": $RETAIL_INTERFACE
                  }
                ]
              }
            ]
          }
          EOF

          # Create GitHub release
          gh release create "$BASE" \
            "RCPT_${BASE}_Retail.zip" "release.json" \
            --title "$BASE" --notes "Retail release for $BASE"

      - name: If beta build needed, create beta release
        run: |
          set -e
          BASE="${{ steps.decide.outputs.base }}"
          TAG="${{ steps.tag.outputs.tag }}"
          IS_BETA="${{ steps.decide.outputs.is_beta }}"
          OUTPUT_TAG="$TAG"

          # For stable tags, we explicitly make a beta tag
          if [[ "$IS_BETA" == "false" ]]; then
            OUTPUT_TAG="${BASE}-beta"
            echo "Creating a beta tag name: $OUTPUT_TAG"
          fi

          echo "Generating Beta release for $OUTPUT_TAG"

          # Rewrite TOCs for Beta
          for toc in \
            release/RCPT/*.toc \
            release/RCPT_PullTimers/*.toc \
            release/RCPT_TalentCheck/*.toc
          do
            [ -f "$toc" ] || continue
            sed -E -i "s/^## Interface:.*$/## Interface: $BETA_INTERFACE/" "$toc"
          done

          cd release
          zip -r "RCPT_${OUTPUT_TAG}.zip" RCPT RCPT_PullTimers RCPT_TalentCheck

          # Create release.json for beta
          cat > "release.json" <<EOF
          {
            "releases": [
              {
                "name": "RCPT",
                "version": "${OUTPUT_TAG}",
                "filename": "RCPT_${OUTPUT_TAG}.zip",
                "nolib": false,
                "metadata": [
                  {
                    "flavor": "beta",
                    "interface": $BETA_INTERFACE
                  }
                ]
              }
            ]
          }
          EOF

          # Create GitHub release
          gh release create "$OUTPUT_TAG" \
            "RCPT_${OUTPUT_TAG}.zip" "release.json" \
            --title "$OUTPUT_TAG" --notes "Beta release for $OUTPUT_TAG"
