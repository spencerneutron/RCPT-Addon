name: Build and Publish RCPT Addon

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      RETAIL_INTERFACE: 110207
      BETA_INTERFACE:   120001

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Decide release mode
        id: decide
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          BASE="${TAG%-beta}"
          BASE="${BASE#v}"          # strip leading v
          IS_BETA="false"

          if [[ "$TAG" == *"-beta"* ]]; then
            IS_BETA="true"
          fi

          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "is_beta=$IS_BETA" >> "$GITHUB_OUTPUT"

      - name: Prepare addon folder
        run: |
          set -e
          rm -rf release
          mkdir -p release
          cp -r RCPT RCPT_PullTimers RCPT_TalentCheck release/

      ############################################################
      # Retail Release (ONLY when not beta)
      ############################################################
      - name: Create Retail release
        if: steps.decide.outputs.is_beta == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          BASE="${{ steps.decide.outputs.base }}"

          echo "Updating RCPT.toc version to $BASE"

          sed -E -i \
            "s/^## Version .*/## Version $BASE/" \
            release/RCPT/RCPT.toc

          cd release
          zip -r "RCPT_${BASE}.zip" RCPT RCPT_PullTimers RCPT_TalentCheck

          cat > "release.json" <<EOF
          {
            "releases": [
              {
                "name": "RCPT",
                "version": "${BASE}",
                "filename": "RCPT_${BASE}.zip",
                "nolib": false,
                "metadata": [
                  {
                    "flavor": "mainline",
                    "interface": $RETAIL_INTERFACE
                  }
                ]
              }
            ]
          }
          EOF

          gh release create "v${BASE}" \
            "RCPT_${BASE}.zip" "release.json" \
            --title "v${BASE}" \
            --notes "Retail release for v${BASE}"

      ############################################################
      # Beta Release (ONLY when tag is beta)
      ############################################################
      - name: Create Beta release
        if: steps.decide.outputs.is_beta == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG="${{ steps.tag.outputs.tag }}"
          BASE="${{ steps.decide.outputs.base }}"

          echo "Updating RCPT.toc version to $BASE (beta)"

          sed -E -i \
            "s/^## Version .*/## Version $BASE/" \
            release/RCPT/RCPT.toc

          # Rewrite interface to beta
          for toc in \
            release/RCPT/*.toc \
            release/RCPT_PullTimers/*.toc \
            release/RCPT_TalentCheck/*.toc
          do
            [ -f "$toc" ] || continue
            sed -E -i "s/^## Interface:.*$/## Interface: $BETA_INTERFACE/" "$toc"
          done

          cd release
          zip -r "RCPT_${TAG}.zip" RCPT RCPT_PullTimers RCPT_TalentCheck

          cat > "release.json" <<EOF
          {
            "releases": [
              {
                "name": "RCPT",
                "version": "${BASE}-beta",
                "filename": "RCPT_${TAG}.zip",
                "nolib": false,
                "metadata": [
                  {
                    "flavor": "beta",
                    "interface": $BETA_INTERFACE
                  }
                ]
              }
            ]
          }
          EOF

          gh release create "${TAG}" \
            "RCPT_${TAG}.zip" "release.json" \
            --title "${TAG}" \
            --notes "Beta release for ${TAG}"
