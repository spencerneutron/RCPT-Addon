name: Build and Publish RCPT Addon

on:
  push:
    tags:
      - 'v*'   # matches both vX.Y.Z and vX.Y.Z-beta

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      RETAIL_INTERFACE: 110207
      BETA_INTERFACE:   120001

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Decide release mode
        id: decide
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          BASE="${TAG%-beta}"          # strip -beta suffix if present
          IS_BETA="false"
          if [[ "$TAG" == *"-beta"* ]]; then
            IS_BETA="true"
          fi
          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "is_beta=$IS_BETA" >> "$GITHUB_OUTPUT"

      - name: Prepare addon folder
        run: |
          set -e
          rm -rf release
          mkdir -p release
          cp -r RCPT RCPT_PullTimers RCPT_TalentCheck release/

      ################################################################
      # Retail release (only if the tag does NOT include "-beta")
      ################################################################
      - name: Create Retail release
        if: steps.decide.outputs.is_beta == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          BASE="${{ steps.decide.outputs.base }}"
          echo "Generating Retail release for $BASE"

          # Build zip without altering any TOCs
          cd release
          zip -r "RCPT_${BASE}.zip" RCPT RCPT_PullTimers RCPT_TalentCheck

          # Generate a release.json with only retail metadata
          cat > "release.json" <<EOF
          {
            "releases": [
              {
                "name": "RCPT",
                "version": "${BASE}",
                "filename": "RCPT_${BASE}.zip",
                "nolib": false,
                "metadata": [
                  {
                    "flavor": "mainline",
                    "interface": $RETAIL_INTERFACE
                  }
                ]
              }
            ]
          }
          EOF

          # Publish the Retail release on GitHub
          gh release create "$BASE" \
            "RCPT_${BASE}_Retail.zip" "release.json" \
            --title "$BASE" \
            --notes "Retail release for $BASE"

      ################################################################
      # Beta release (always run; if not a beta tag, generate vX.Y.Z-beta)
      ################################################################
      - name: Create Beta release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          BASE="${{ steps.decide.outputs.base }}"
          IS_BETA="${{ steps.decide.outputs.is_beta }}"
          TAG="${{ steps.tag.outputs.tag }}"

          # Decide output tag: use existing beta tag or generate one
          if [[ "$IS_BETA" == "false" ]]; then
            OUTPUT_TAG="${BASE}-beta"
          else
            OUTPUT_TAG="$TAG"
          fi

          echo "Generating Beta release for $OUTPUT_TAG"

          # Rewrite TOCs to use the BETA interface
          for toc in \
            release/RCPT/*.toc \
            release/RCPT_PullTimers/*.toc \
            release/RCPT_TalentCheck/*.toc
          do
            [ -f "$toc" ] || continue
            sed -E -i "s/^## Interface:.*$/## Interface: $BETA_INTERFACE/" "$toc"
          done

          # Zip the modified beta addon
          cd release
          zip -r "RCPT_${OUTPUT_TAG}.zip" RCPT RCPT_PullTimers RCPT_TalentCheck

          # Generate the beta release.json
          cat > "release.json" <<EOF
          {
            "releases": [
              {
                "name": "RCPT",
                "version": "${OUTPUT_TAG}",
                "filename": "RCPT_${OUTPUT_TAG}.zip",
                "nolib": false,
                "metadata": [
                  {
                    "flavor": "beta",
                    "interface": $BETA_INTERFACE
                  }
                ]
              }
            ]
          }
          EOF

          # Publish the Beta release on GitHub
          gh release create "$OUTPUT_TAG" \
            "RCPT_${OUTPUT_TAG}.zip" "release.json" \
            --title "$OUTPUT_TAG" \
            --notes "Beta release for $OUTPUT_TAG"
